<template>
    <div class="form-media">
        <div class="media-progress" v-if="form.progress">
            <div class="bar" :style="{width: form.progress}"></div>
        </div>

        <div class="media-row-container dropzone"
             @dragover.prevent="form.dragOver = true"
             @dragleave.prevent="form.dragOver = false"
             @dragdrop.prevent="this.form.dragOver = false; this.form.highlight = false;"
             @drop.prevent="drop"
        >
            <span class="indicator icon icon-image"></span>
            <ul>
                <draggable
                    v-model="form.children"
                    item-key="name"
                    @change="event => { form.changeOrder(event) }"
                    @start="event => { form.dragStart(event) }"
                    @end="event => { form.dragEnd(event) }"
                    :group="form.draggableGroup"
                    :handle="form.draggableHandle"
                    tag="li"
                >
                    <template #item="{ element }">
                        <component
                            :is="form.itemComponent"
                            :form="element"
                            :deletable="form.allowDelete"
                            :sortable="form.multiple && form.sortable"
                            @delete="event => { form.deleteItem(event) }"
                            @up="event => { form.moveItemUp(event) }"
                            @down="event => { form.moveItemDown(event) }"
                        />
                    </template>
                </draggable>
            </ul>
        </div>

        <div class="related-buttons-row">
            <button class="btn has-symbol upload-button" v-if="form.upload"  @click.prevent="form.startUpload()">{{ form.uploadLabel }}</button>
            <button class="btn has-symbol" v-for="button of form.buttons">{{ button.label }}</button>
        </div>

        <input :id="form.id" name="files[]" type="file" class="upload-input" multiple style="display: none" ref="element" @change.prevent="form.change">
    </div>
</template>

<script lang="ts">
import {Vue, Options, Inject, Prop} from "vue-property-decorator";
import {MediaForm} from "@enhavo/media/form/model/MediaForm";
import {FormUtil} from "@enhavo/vue-form/form/FormUtil";
import * as $ from "jquery";
import * as draggable from "vuedraggable";

@Options({
    components: {'draggable': draggable}
})
export default class extends Vue
{
    @Prop()
    form: MediaForm;

    updated()
    {
        this.form.element = <HTMLElement>this.$refs.element;
        FormUtil.updateAttributes(this.form.element, this.form.attr);
    }

    mounted()
    {
        this.form.element = <HTMLElement>this.$refs.element;
        FormUtil.updateAttributes(this.form.element, this.form.attr);

        $(window).on('dragenter dragover', () => {
            this.form.highlight = true;
        });

        $(window).on('dragleave', () => {
            this.form.highlight = false;
        });
    }

    drop(event: DragEvent)
    {
        this.form.dragOver = false;
        this.form.highlight = false;

        this.form.drop(event.dataTransfer);
    }
}
</script>
