<template>
    <div class="media-type">
        <div class="media-extensions">
<!--            <component :is />-->
        </div>

        <div class="media-progress">
            <div class="bar" style="width: 0;"></div>
        </div>

        <div class="media-row-container">
            <span class="indicator icon icon-image"></span>
            <ul>
                <draggable
                    v-model="form.children"
                    item-key="name"
                    @change="event => { form.changeOrder(event) }"
                    @start="event => { form.dragStart(event) }"
                    @end="event => { form.dragEnd(event) }"
                    :group="form.draggableGroup"
                    :handle="form.draggableHandle"
                    tag="li"
                >
                    <template #item="{ element }">
                        <component
                            :is="form.itemComponent"
                            :form="element"
                            :deletable="form.allowDelete"
                            :sortable="form.sortable"
                            @delete="event => { form.deleteItem(event) }"
                            @up="event => { form.moveItemUp(event) }"
                            @down="event => { form.moveItemDown(event) }"
                        />
                    </template>
                </draggable>
            </ul>


            <ul :class="{'multiple': form.multiple, 'sortable': form.sortable, 'editable': form.editable}" class="media-row drop-zone">
                <li class="media-item">
                    <form-widget :form="child" v-for="child of form.children" />
                </li>
            </ul>
        </div>

        <div
            class="dropzone"
            style="height: 100px; width: 100px;"
            :style="style()"
            @dragover.prevent="form.dragOver = true"
            @dragleave.prevent="form.dragOver = false"
            @dragdrop.prevent="this.form.dragOver = false; this.form.highlight = false;"
            @drop.prevent="drop"
        ></div>

        <div class="related-buttons-row">
            <button class="btn has-symbol upload-button" v-if="form.upload"  @click.prevent="form.startUpload()">{{ form.uploadLabel }}</button>
            <button class="btn has-symbol" v-for="button of form.buttons">{{ button.label }}</button>
        </div>

        <input :id="form.id" name="files[]" type="file" class="upload-input" multiple style="display: none" ref="element" @change.prevent="form.change">
    </div>
</template>

<script lang="ts">
import {Vue, Options, Inject, Prop} from "vue-property-decorator";
import {MediaForm} from "@enhavo/media/form/model/MediaForm";
import {FormUtil} from "@enhavo/vue-form/form/FormUtil";
import * as $ from "jquery";

@Options({})
export default class extends Vue
{
    @Prop()
    form: MediaForm;

    style()
    {
        if (this.form.dragOver) {
            return "background-color: red";
        } else if (this.form.highlight) {
            return "background-color: green";
        }

        return "background-color: blue";
    }

    updated()
    {
        this.form.element = <HTMLElement>this.$refs.element;
        FormUtil.updateAttributes(this.form.element, this.form.attr);
    }

    mounted()
    {
        this.form.element = <HTMLElement>this.$refs.element;
        FormUtil.updateAttributes(this.form.element, this.form.attr);

        $(window).on('dragenter dragover', () => {
            this.form.highlight = true;
        });

        $(window).on('dragleave', () => {
            this.form.highlight = false;
        });
    }

    drop(event: DragEvent)
    {
        this.form.dragOver = false;
        this.form.highlight = false;

        this.form.drop(event.dataTransfer);
    }
}
</script>
