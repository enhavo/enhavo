<template>
    <div class="app-view">
        <view-view></view-view>
        <flash-messages></flash-messages>
        <action-bar></action-bar>
        <input v-once type="file" multiple ref="upload" v-show="false">
        <div class="media-library-overlay" data-media-library-overlay>
            <div class="close-media-library-overlay button-icon icon-cross" data-media-library-close></div>
            <div class="inner-content" data-scroll-container>
                <div class="tag-list">
                    <div class="headline"><i class="icon icon-filter_list"></i> {{ $translator.trans('enhavo_media_library.tags') }}</div>
                    <tag-list
                        :tags="$MediaLibrary.data.tags"
                    ></tag-list>

                    <div class="headline"><i class="icon icon-filter_list"></i> {{ $translator.trans('enhavo_media_library.content_types') }}</div>
                    <content-type-list
                        :content-types="$MediaLibrary.data.contentTypes"
                    ></content-type-list>
                </div>

                <div class="result-search">
                    <div class="search">
                        <input ref="searchInput" v-model="$MediaLibrary.data.searchString" type="text" data-media-library-search />
                        <span @click="clearSearch()" class="coconut-search-reset"><i class="icon icon-close"></i></span>
                        <span @click="search()" class="coconut-search-submit"><i class="icon icon-search"></i></span>
                    </div>
                    <ul v-if="!$MediaLibrary.data.loading" class="images" data-media-library-result ref="itemList">
                        <image-component
                            v-for="item of $MediaLibrary.data.items"
                            :item="item"
                            :data="$MediaLibrary.data"
                            v-bind:key="item.id"
                        ></image-component>
                    </ul>
                    <div class="lds-ellipsis" v-else><div></div><div></div><div></div><div></div></div>
                </div>
            </div>
        </div>
    </div>
</template>

<script lang="ts">
    import * as $ from 'jquery';
    import { Vue, Component, Prop, Watch } from "vue-property-decorator";
    import '@enhavo/app/assets/styles/view.scss';
    import ActionBar from "@enhavo/app/action/components/ActionBar.vue";
    import FlashMessages from "@enhavo/app/flash-message/components/FlashMessages.vue";
    import ViewComponent from "@enhavo/app/view/components/ViewComponent.vue";
    import TagListComponent from "@enhavo/media-library/components/TagListComponent.vue";
    import TagComponent from "@enhavo/media-library/components/TagComponent.vue";
    import ImageComponent from "@enhavo/media-library/components/ImageComponent.vue";
    import ContentTypeListComponent from "@enhavo/media-library/components/ContentTypeListComponent.vue";
    import ContentTypeComponent from "@enhavo/media-library/components/ContentTypeComponent.vue";

    Vue.component('tag-component', TagComponent);
    Vue.component('tag-list', TagListComponent);
    Vue.component('content-type', ContentTypeComponent);
    Vue.component('content-type-list', ContentTypeListComponent);
    Vue.component('image-component', ImageComponent);

    @Component({
        components: {
            TagListComponent,
            ContentTypeListComponent,
            ImageComponent,
            'flash-messages': FlashMessages,
            'action-bar': ActionBar,
            'view-view': ViewComponent
        }
    })

    export default class ApplicationComponent extends Vue
    {
        @Prop()
        tags: Array<any>;

        @Watch('searchString')
        onChangeSearchString(val:string)
        {
          this.getMediaLibrary().data.searchString = val;
        }

        getAddLabel()
        {
            if(this.getMediaLibrary().data.multiple){
                return "Ausgew채hlte Bilder hinzuf체gen"; // todo: translate
            } else {
                return "Ausgew채hltes Bild hinzuf체gen"; // todo: translate
            }
        }

        search()
        {
            this.getMediaLibrary().search();
        }

        clearSearch()
        {
            this.getMediaLibrary().clearSearch()

        }

        created()
        {
            window.addEventListener('keydown', (e) => {
                if (e.key == 'Enter') {
                    let isSearchFocus = $(this.$refs.searchInput).is(':focus');
                    if(isSearchFocus){
                        this.search();
                    }
                }
            });
        }

        mounted()
        {
            let element = this.$refs.upload;

            $(document).on('upload', function () {
                $(element).trigger('click');
            });

            $(element).fileupload({
                replaceFileInput: false,
                dataType: 'json',
                paramName: 'files',
                done: (event, data) => {
                    this.getMediaLibrary().refresh();
                    // this.open()
                    console.log(data);
                },
                fail: (event, data) => {
                    this.getMediaLibrary().fail();
                    console.log(data);
                },
                add: (event, data) => {
                    data.url = this.getRouter().generate('enhavo_media_library_upload', {});
                    data.submit();
                    this.getMediaLibrary().loading();
                    console.log(data);
                },
                progressall: (event, data) => {
                    let progress = data.loaded / data.total * 100;
                    if (progress >= 100) {
                        this.getMediaLibrary().setProgress(0);
                    } else {
                        this.getMediaLibrary().setProgress(progress);
                    }
                    console.log(data);
                },
                dropZone: this.$refs.itemList,
                pasteZone: null
            });

            $(document).bind('dragover', (e) =>  {
                e.preventDefault();
                e.stopPropagation();
                this.getMediaLibrary().showDropZone();
            });

            $(this.$refs.mediaLibrary).bind('dragover', (e) =>  {
                e.preventDefault();
                e.stopPropagation();
                this.getMediaLibrary().showDropZone();
                this.getMediaLibrary().showDropZoneActive();
            });

            $(document).bind('dragleave', (e) => {
                if($(document).find('.app-view').length > 0 && $(document).find('.app-view').find(e.target).length > 0) return;
                e.preventDefault();
                e.stopPropagation();
                this.getMediaLibrary().hideDropZone();
            });

            $(this.$refs.mediaLibrary).bind('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.getMediaLibrary().hideDropZoneActive();
            });

            $(document).bind('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.getMediaLibrary().hideDropZone();
                this.getMediaLibrary().hideDropZoneActive();
            });
        }

        open(item: MediaItem) {
            this.getMediaLibrary().open(item)
        }

        getMediaLibrary()
        {
            return this.$MediaLibrary;
        }

        getRouter()
        {
            return this.$router;
        }

        getType(extension)
        {
            if(extension == 'png' || extension == 'jpg' ||  extension == 'jpeg' ||  extension == 'gif') {
                return 'image';
            }

            if(extension == 'pdf') {
                return 'document';
            }

            return 'file';
        }
    }
</script>
